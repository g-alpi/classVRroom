<html>
    {% include "header.html" with title="Fast Correction" task=task.nombre cursoid=curso.pk %}
        {% block content %}
        <h2 class="pt-5 pl-20 text-4xl">{{task.nombre}}</h2>

        <div id="table" class="pl-20 pr-20 pt-5 ">
            <div class="border-solid rounded border-black bg-[#ededed] p-2 mx-8 mb-3">
                <table id="fctable" style="border: 1px ; border-radius: 10px;" class="min-w-full">
                    <tr class="font-bold text-center">
                        <td>Alumno</td>
                        <td>Correo</td>
                        <td>Calificación</td>
                        <td>Fecha de Entrega</td>
                        <td>Comentario Alumno</td>
                        <td>Archivo</td>
                        <td>Comentario Profesor</td>
                        <td>Actualizar</td>
                    </tr>
                    {% if deliveries %}
                    {% for d in deliveries %}
                                <tr class="text-center">
                                    <td>{{d.user}}</td>
                                    <td>{{d.user.correo}}</td>
                                    {% for q in qualifications %}
                                        {% if q.tarea == d.tarea.pk %}
                                            <td class="{{d.pk}}"><input type="number" value="{{q.nota}}" class="nota" class="text-center"></td>
                                        {% endif %}
                                    {% empty %}
                                        {% load static %}
                                        <td class="flex justify-end items-center pt-1 {{d.pk}} h-[100]"><input type="number" value="0" class="nota" class="text-center"><img class="max-w-[18px] max-h-[18px] ml-3" src="{% static 'warning.png' %}" alt="Warning"></td>
                                    {% endfor %}
                                    <td>{{d.fecha_entrega}}</td>
                                    {% if d.comentario_alumno %}
                                        <td class="{{d.pk}}">{{d.comentario_alumno}}</td>
                                    {% else %}
                                        <td class="italic {{d.pk}}">Sin comentario</td>
                                    {% endif %}
                                    <td><a href="../{{d.archivo}}" class="underline text-[#461f87] italic">Descargar</a></td>
                                    {% if d.comentario_profesor %}
                                        <td class="{{d.pk}}"><textarea name="comentarioProfesor" id="" cols="30" rows="5" class="comentarioProfesor">{{d.comentario_profesor}}</textarea></td>
                                        
                                    {% else %}
                                        <td class="{{d.pk}}"><textarea name="comentarioProfesor" id="" cols="30" rows="5" class="comentarioProfesor">Sin comentario</textarea></td>
                                    {% endif %}
                                    <td><button name="" id="{{d.pk}}" class="p-1 m-1 text-sm actualizar">Actualizar</button></td>
                                </tr>
                    {% endfor %}
                    {% for a in alumnos %}
                        {% if a.pk in alumnosEntregado %}
                            <tr class="text-center">
                                <td>{{a.user}}</td>
                                <td class="italic text-red-700">No calificado</td>
                                <td class="italic text-red-700">No entregado</td>
                                <td class="italic">Sin comentario</td>
                                <td>-</td>
                                <td class="italic">Sin comentario</td>
                                <td></td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                    {% else %}
                    <tr><td>No hay entregas</td></tr>
                    {% endif %}
                </table>    
                
            </div>
        </div>
        <script>
            $(document).ready(function() {
                $('.actualizar').each(function() {
                    $(this).on('click', function () {

                        let nota = $("."+this.id+' .nota').val();
                        let comentarioProfesor = $("."+this.id+' .comentarioProfesor').val();
                        if (comentarioProfesor=="") {
                            comentarioProfesor="Sin comentarios"
                        }
                        let entrega =  this.id;
                        console.log(window.location.origin+"/actualizar/"+entrega+"/"+nota+"/"+comentarioProfesor);
                        $.ajax({
                            url: window.location.origin+"/actualizar/"+entrega+"/"+nota+"/"+comentarioProfesor,
                            method : 'POST',
                        })

                        if (nota=="gola" && comentarioProfesor=="cosa") {
                            $("table").before('<div class="alert warning"> <span class="closebtn">&times;</span>No se ha actualizado la información, modifica los campos y vuelve a enviar</div>');
                            
                        }
                        else{
                            $("table").before('<div class="alert success"> <span class="closebtn">&times;</span>La información se ha actualizado correctamente</div>');
                        }
                        eliminarAlerta();
                        setTimeout(function(){ location.reload()}, 1000);

                        
                    })
                    
                });

                    });
            
        </script>
        {% endblock %}
    </body>
<html>